const RightMenu=(()=>{const e=volantis.GLOBAL_CONFIG.plugins.rightmenu,t=volantis.GLOBAL_CONFIG.plugins.message.enable&&volantis.GLOBAL_CONFIG.plugins.message.rightmenu.enable,o={},n=document.getElementById("rightmenu-wrapper"),r=document.getElementById("rightmenu-content"),l=document.getElementById("printHtml"),i=document.getElementById("menuMusic"),a=document.getElementById("readingModel"),c=document.getElementById("read_bkg"),s=document.querySelectorAll(".menuLoad-Content"),d=document.querySelector(".menu-Option"),u=document.querySelector('.menu-Option[data-fn-type="searchWord"]'),m=document.querySelector('.menu-Option[data-fn-type="copyText"]'),p=document.querySelector('.menu-Option[data-fn-type="copyPaste"]'),g=document.querySelector('.menu-Option[data-fn-type="copySelect"]'),y=document.querySelector('.menu-Option[data-fn-type="copyCut"]'),M=document.querySelector('.menu-Option[data-fn-type="copyHref"]'),C=document.querySelector('.menu-Option[data-fn-type="copySrc"]'),v=document.querySelector('.menu-Option[data-fn-type="copyImg"]'),O=document.querySelector('.menu-Option[data-fn-type="openTab"]'),b=document.querySelector("#menuMusic .backward"),h=document.querySelector("#menuMusic .toggle"),D=document.querySelector("#menuMusic .forward"),S=/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;return o.init=()=>{DOMController.visible(i,!1),DOMController.visible(d,!1),c&&c.parentNode.removeChild(c);const e=document.createElement("div");e.className="common_read_bkg common_read_hide",e.id="read_bkg",window.document.body.appendChild(e)},o.initEvent=()=>{window.document.oncontextmenu=e=>e.ctrlKey||document.body.offsetWidth<=500?(o.hideMenu(),!0):o.popMenu(e),n.oncontextmenu=e=>(e.stopPropagation(),e.preventDefault(),!1),window.removeEventListener("blur",o.hideMenu),window.addEventListener("blur",o.hideMenu),document.body.removeEventListener("click",o.hideMenu),document.body.addEventListener("click",o.hideMenu),D&&h&&D&&(b.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerBackward()},h.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerToggle()},D.onclick=e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerForward()})},o.popMenu=e=>{let t=e.clientX,l=e.clientY,i=document.documentElement.clientWidth||document.body.clientWidth,a=document.documentElement.clientHeight||document.body.clientHeight;try{o.setMenuItem(e),DOMController.visible(n),n.focus(),n.style.zIndex="-2147483648";let c=r.offsetWidth,s=r.offsetHeight,d=t+c>i?t-c+10:t,u=l+s>a?l-s+10:l;u=l+s>a&&u<s&&l<s?u+(a-s-u-10):u,n.style.left=d+"px",n.style.top=u+"px",n.style.zIndex="2147483648",volantis.GLOBAL_CONFIG.plugins.message.rightmenu.notice&&o.showMessage()}catch(e){return n.blur(),console.error(e),!0}return!1},o.showMessage=()=>{const o="true"===localStorage.getItem("NoticeRightMenu");t&&!o&&VolantisApp.message("右键菜单","唤醒原系统菜单请使用：<kbd>Ctrl</kbd> + <kbd>右键</kbd>",{icon:e.faicon+" fa-exclamation-square red",time:9e3},(()=>{localStorage.setItem("NoticeRightMenu","true")}))},o.setMenuItem=n=>{let r=!1;const c=n.target,d=window.getSelection().toString();if(DOMController.visible(O,!1),"input"===c.tagName.toLowerCase()||"textarea"===c.tagName.toLowerCase()){const e=c.value;e.length>0?(DOMController.visible(g),g.onclick=()=>{n.preventDefault(),c.select()}):DOMController.visible(g,!1),d?(DOMController.visible(y),y.onclick=()=>{const t=c.selectionStart,n=c.selectionEnd;o.copyString(d),c.value=e.substring(0,t)+e.substring(n,e.length),c.selectionStart=t,c.selectionEnd=t,c.focus()}):DOMController.visible(y,!1),o.readClipboard().then((e=>{e?(DOMController.visible(p),p.onclick=()=>{o.insertAtCaret(c,e)}):DOMController.visible(p,!1)})).catch((e=>{console.error(e),DOMController.visible(p,!1)}))}else DOMController.visible(g,!1),DOMController.visible(p,!1),DOMController.visible(y,!1);const b=c.href;b&&S.test(b)?(r=!0,DOMController.visible(M),DOMController.visible(O),M&&(M.onclick=()=>{o.copyString(b)}),O.onclick=()=>{window.open(b)}):DOMController.visible(M,!1);const h=c.currentSrc;h&&S.test(h)?(r=!0,DOMController.visible(C),DOMController.visible(O),C.onclick=()=>{o.copyString(h)},O.onclick=()=>{window.open(h)}):DOMController.visible(C,!1),h&&S.test(h)&&h.trimEnd().endsWith(".png")?(r=!0,DOMController.visible(v),v.onclick=()=>{o.writeClipImg(n,(o=>{o&&t&&VolantisApp.message("系统提示","图片复制成功！",{icon:e.faicon+" fa-images"})}),(o=>{t&&VolantisApp.message("系统提示","复制失败："+o,{icon:e.faicon+" fa-exclamation-square red"})}))}):DOMController.visible(v,!1),d?(r=!0,DOMController.visible(m),DOMController.visible(u),m.onclick=()=>{o.copyString(d)},u&&(u.onclick=()=>{OpenSearch(d)})):(DOMController.visible(m,!1),DOMController.visible(u,!1));const D=document.querySelector("#post.article")||null,f=window.location.pathname;D?(DOMController.visible(l),DOMController.visible(a),l&&(l.onclick=()=>{if(window.location.pathname===f){const e='是否打印当前页面？<br><em style="font-size: 80%">建议打印时勾选背景图形</em><br>';t&&VolantisApp.question("",e,{},(()=>{o.printHtml()}))}else o.hideMenu()}),a&&(a.onclick=()=>{window.location.pathname,o.readingModel()})):(DOMController.visible(l,!1),DOMController.visible(a,!1)),volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&"undefined"!=typeof RightMenuAplayer&&void 0!==RightMenuAplayer.APlayer.player?e.music_alwaysShow?DOMController.visible(i):"play"===RightMenuAplayer.APlayer.status||"undefined"===RightMenuAplayer.APlayer.status?(r=!0,DOMController.visible(i)):DOMController.visible(i,!1):DOMController.visible(i,!1),s.forEach((e=>{DOMController.visible(e,!r)})),volantis.GLOBAL_CONFIG.plugins.aplayer.enable&&e.layout.includes("music")&&RightMenuAplayer.checkAPlayer()},o.hideMenu=()=>{DOMController.visible(n,!1)},o.copyString=o=>{VolantisApp.utilWriteClipText(o).then((()=>{t&&VolantisApp.messageCopyright()})).catch((o=>{t&&VolantisApp.message("系统提示",o,{icon:e.faicon+" fa-exclamation-square red"})}))},o.writeClipText=e=>{try{return navigator.clipboard.writeText(e).then((()=>Promise.resolve())).catch((e=>Promise.reject(e)))}catch(t){const o=document.createElement("input");o.setAttribute("readonly","readonly"),document.body.appendChild(o),o.setAttribute("value",e),o.select();try{let e=document.execCommand("copy");return document.body.removeChild(o),e&&"unsuccessful"!==e?Promise.resolve():Promise.reject("复制文本失败!")}catch(e){return document.body.removeChild(o),Promise.reject("当前浏览器不支持复制功能，请检查更新或更换其他浏览器操作!")}}},o.writeClipImg=async function(t,o,n){const r=e.customPicUrl.enable?t.target.currentSrc.replace(e.customPicUrl.old,e.customPicUrl.new):t.target.currentSrc,l=t.target.parentElement;try{const e=await fetch(r),t=await e.blob();await navigator.clipboard.write([new ClipboardItem({[t.type]:t})]).then((()=>{o(!0)}),(e=>{console.error("图片复制失败：",e),n(e)}))}catch(e){const t=document;try{if(t.body.createTextRange){const e=document.body.createTextRange();e.moveToElementText(l),e.select()}else if(window.getSelection){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(l),e.removeAllRanges(),e.addRange(t)}document.execCommand("copy"),window.getSelection().removeAllRanges(),o(!1)}catch(e){console.error(e),n("不支持复制当前图片！")}}},o.readClipboard=async()=>{const e=await navigator.permissions.query({name:"clipboard-read"});return"granted"===e.state||"prompt"===e.state?navigator.clipboard.readText().then((e=>e)).catch((e=>Promise.reject(e))):Promise.reject(e)},o.insertAtCaret=(e,t)=>{const o=e.selectionStart,n=e.selectionEnd;if(document.selection)e.focus(),document.selection.createRange().text=t,e.focus();else if(o||"0"==o){var r=e.scrollTop;e.value=e.value.substring(0,o)+t+e.value.substring(n,e.value.length),e.focus(),e.selectionStart=o+t.length,e.selectionEnd=o+t.length,e.scrollTop=r}else e.value+=t,e.focus()},o.printHtml=()=>{volantis.isReadModel&&o.readingModel(),DOMController.setAttribute("details","open","true"),DOMController.remove(".cus-article-bkg"),DOMController.remove(".iziToast-overlay"),DOMController.remove(".iziToast-wrapper"),DOMController.remove(".prev-next"),DOMController.remove("footer"),DOMController.remove("#l_header"),DOMController.remove("#l_cover"),DOMController.remove("#l_side"),DOMController.remove("#comments"),DOMController.remove("#s-top"),DOMController.remove("#BKG"),DOMController.remove("#rightmenu-wrapper"),DOMController.remove(".nav-tabs"),DOMController.remove(".parallax-mirror"),DOMController.remove(".new-meta-item.share"),DOMController.remove("div.footer"),DOMController.setStyle("body","backgroundColor","unset"),DOMController.setStyle("#l_main","width","100%"),DOMController.setStyle("#post","boxShadow","none"),DOMController.setStyle("#post","background","none"),DOMController.setStyle("#post","padding","0"),DOMController.setStyle("h1","textAlign","center"),DOMController.setStyle("h1","fontWeight","600"),DOMController.setStyle("h1","fontSize","2rem"),DOMController.setStyle("h1","marginBottom","20px"),DOMController.setStyle(".tab-pane","display","block"),DOMController.setStyle(".tab-content","borderTop","none"),DOMController.setStyle(".highlight>table pre","whiteSpace","pre-wrap"),DOMController.setStyle(".highlight>table pre","wordBreak","break-all"),DOMController.setStyle(".fancybox img","height","auto"),DOMController.setStyle(".fancybox img","weight","auto"),setTimeout((()=>{window.print(),document.body.innerHTML="",window.location.reload()}),50)},o.readingModel=()=>{if("function"==typeof ScrollReveal&&ScrollReveal().clean("#comments"),DOMController.fadeToggle(document.querySelector("#l_header")),DOMController.fadeToggle(document.querySelector("footer")),DOMController.fadeToggle(document.querySelector("#s-top")),DOMController.fadeToggle(document.querySelector(".article-meta#bottom")),DOMController.fadeToggle(document.querySelector(".prev-next")),DOMController.fadeToggle(document.querySelector("#l_side")),DOMController.fadeToggle(document.querySelector("#comments")),DOMController.toggleClass(document.querySelector("#l_main"),"common_read"),DOMController.toggleClass(document.querySelector("#l_main"),"common_read_main"),DOMController.toggleClass(document.querySelector("#l_body"),"common_read"),DOMController.toggleClass(document.querySelector("#safearea"),"common_read"),DOMController.toggleClass(document.querySelector("#pjax-container"),"common_read"),DOMController.toggleClass(document.querySelector("#read_bkg"),"common_read_hide"),DOMController.toggleClass(document.querySelector("h1"),"common_read_h1"),DOMController.toggleClass(document.querySelector("#post"),"post_read"),DOMController.toggleClass(document.querySelector("#l_cover"),"read_cover"),DOMController.toggleClass(document.querySelector(".widget.toc-wrapper"),"post_read"),volantis.isReadModel=void 0===volantis.isReadModel||!volantis.isReadModel,volantis.isReadModel){const n={backgroundColor:"var(--color-read-post)",icon:e.faicon+" fa-book-reader",time:5e3};t&&VolantisApp.message("系统提示","阅读模式已开启，您可以点击屏幕空白处退出。",n),document.querySelector("#l_body").removeEventListener("click",o.readingModel),document.querySelector("#l_body").addEventListener("click",(e=>{DOMController.hasClass(e.target,"common_read")&&o.readingModel()}))}else document.querySelector("#l_body").removeEventListener("click",o.readingModel),document.querySelector("#post").removeEventListener("click",o.readingModel)},{init:(e=!1)=>{o.init(),o.initEvent(),e&&t&&VolantisApp.message("系统提示","自定义右键注册成功。")},destroy:(e=!1)=>{o.hideMenu(),window.document.oncontextmenu=()=>!0,e&&t&&VolantisApp.message("系统提示","自定义右键注销成功。")},hideMenu:o.hideMenu,readingModel:o.readingModel}})();Object.freeze(RightMenu),volantis.requestAnimationFrame((()=>{"loading"!==document.readyState?(RightMenu.init(),volantis.pjax.send((()=>{RightMenu.hideMenu()}))):document.addEventListener("DOMContentLoaded",(function(){RightMenu.init(),volantis.pjax.send((()=>{RightMenu.hideMenu()}))}))}));